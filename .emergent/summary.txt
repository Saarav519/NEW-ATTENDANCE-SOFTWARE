<analysis>**original_problem_statement:**
The user initially requested features like mandatory bank details, auto payslips, and new attendance rules. Subsequently, they reported numerous critical issues and requested new features throughout the session.

**New requirements and bug fixes addressed in this session:**
1.  **Bill Partial Approval & Revalidation:** Implement a complete frontend workflow for admins to partially approve bills, send them for revalidation, and for the UI to reflect remaining balances and status changes.
2.  **Cash Out Double Counting:** Fix a critical bug where approved bills were counted in both the payslip's net pay and as separate Cash Out entries, leading to incorrect financial totals.
3.  **Manual Attendance Fields:** Change the Location field in the attendance marking dialog from a dropdown to a manual text input for admins.
4.  **Auto Leave Accrual & Display:** Implement a system where employees accrue 1 leave for every 24 working days and display the leave balance (total, used, available) on the frontend with a year selector.
5.  **Advance Flow Correction:** Ensure a Cash Out entry is created immediately upon an advance being approved and that the payslip correctly marks the advance as deducted upon settlement.
6.  **Payroll UI Correction:** Change the Paid statistic on the Payroll page to show the total monetary amount of settled payslips instead of just a count.
7.  **Historical Data Entry:** Create a new page for admins to manually enter historical, date-wise attendance for an employee, including location and conveyance, with bulk-update capabilities.
8.  **Historical Loan Payments:** When adding an old loan, automatically calculate and create Cash Out entries for all past EMIs that would have been due between the loan start date and the current date.
9.  **TDS on Invoices:** Add TDS (Tax Deducted at Source) percentage and amount fields to the Cash In (Invoice) flow, including the UI, backend logic, and CSV export.
10. **Flowchart Documentation:** Create detailed flowchart-style documentation for the application's core workflows (Attendance, Leave, Bills, Payroll) and the Loan Management system.
11. **Data Resets:** Fulfill multiple user requests to clear all transactional data from the database to allow for fresh testing cycles.

**User's preferred language**: English

**what currently exists?**
A full-stack staff management application (FastAPI, React, MongoDB) with role-based access. Recent major additions include a complete bill revalidation workflow, corrected payroll and cash-out logic, an auto-leave accrual system, a page for manual entry of historical attendance, automatic generation of historical loan payments, and TDS support for invoices. The application's core workflows have also been documented in flowchart-style markdown files.

**Last working item**:
The agent just finished implementing TDS (Tax Deducted at Source) functionality for Cash In invoices.

    - Last item agent was working: The implementation included updating the backend models (, ) and routes (, , ). The frontend  was modified to add TDS input fields to the Add Invoice dialog, and the CSV export function was updated to include GST and TDS columns.
    - Status: **USER VERIFICATION PENDING**
    - Agent Testing Done: Y (Visual verification of UI via screenshot and backend file checks)
    - Which testing method agent to use? both
    - User Testing Done: N

**All Pending/In progress Issue list**:
  - **Issue 1: End-to-End Payroll and Financial Integrity Test (P0)**
    - **Description**: A large number of interconnected financial features (Leave Accrual, Bill Partial Approval, Advance Flow, Manual Attendance) were implemented or fixed. A comprehensive end-to-end test is required to ensure payroll calculations are correct and that no financial data is miscalculated or double-counted.
    - **Status**: NOT STARTED
  - **Issue 2: Critical Payroll Logic Month Mismatch (P0)**
    - **Description**: A recurring critical bug where attendance from one month incorrectly affects the next month's payroll. While addressed in the past, it needs re-verification after recent extensive changes to the payroll logic.
    - **Status**: TESTING PENDING

**Issues Detail**:
  - **Issue 1: End-to-End Payroll and Financial Integrity Test**
     - **Next debug checklist**:
       1.  As admin, create a new employee.
       2.  Navigate to the new manual attendance page and enter a full month of attendance for a past period (e.g., November 2025), including some conveyance.
       3.  Verify on the Profile/Leaves page that the employee has accrued leave for 2025.
       4.  Submit a bill for the employee and have the admin partially approve it, sending the remainder for revalidation.
       5.  Request and approve an advance for the employee for the same month.
       6.  Generate the payslip for that month and verify it correctly includes duty earned (from manual attendance), the partially approved bill amount, and the advance deduction.
       7.  Check the Cashbook to confirm that correct, non-duplicated Cash Out entries were created for the partial bill approval, advance approval, and final salary settlement.
     - **Why fix this issue and what will be achieved with the fix?**: This will validate the stability and correctness of the application's core financial features after a major development push.
     - **Is recurring issue?**: N
     - **Should Test frontend/backend/both after fix?**: both
  - **Issue 2: Critical Payroll Logic Month Mismatch**
     - **Next debug checklist**:
       1.  Using fresh data, mark attendance for an employee on the last day of a month (e.g., Dec 31, 2025).
       2.  Generate a payslip for the *next* month (e.g., Jan 2026).
       3.  Verify that the Jan 2026 payslip shows 0 days worked and â‚¹0 net pay initially.
       4.  Review the  function in  to confirm its date filtering is correct.
     - **Why fix this issue and what will be achieved with the fix?**: This is a critical financial bug. A final verification ensures payroll is calculated accurately for the correct period.
     - **Is recurring issue?**: Y
     - **Should Test frontend/backend/both after fix?**: both

**In progress Task List**:
- None. All initiated tasks were completed.

**Upcoming and Future Tasks**

**Upcoming Tasks:**
-   **P1**: Thoroughly test the half-day attendance calculation and its impact on the  and final payslip.
-   **P1**: Test the complete Revalidation workflow, including the employee resubmission/justification part and final admin approval of the remaining amount.

**Future Tasks:**
-   Refactor the  and  components to reduce their size.
-   Implement multi-language support.
-   Implement a dark mode theme.

**Completed work in this session**
- **Bill Partial Approval & Revalidation**: Implemented the full frontend workflow with separate Approve, Revalidate, and Reject buttons and a clear display of the remaining balance. Fixed the backend to create a Cash Out entry for the partially approved amount during revalidation.
- **Cash Out Double Counting Bug**: Corrected the payroll generation logic in  to prevent approved bills from being counted twice in the Cashbook.
- **Advance Flow Correction**: Ensured a Cash Out entry is created upon advance approval and that advances are correctly marked as deducted when a payslip is settled.
- **Leave Accrual & Display**: Implemented logic for accruing 1 leave per 24 working days and added a My Leave Balance card to the Profile and Leaves pages with a year selector.
- **Manual Attendance Entry Feature**: Created a new page () for admins to perform bulk, date-wise manual entry of historical attendance.
- **Historical Loan EMI Generation**: Enhanced the loan creation process to automatically generate historical EMI payments and corresponding Cash Out entries for past-dated loans.
- **TDS on Invoices**: Added TDS support to the Cash In flow, including UI, backend logic, and CSV export.
- **UI/UX Fixes**: Changed the attendance Location field to a manual input and updated the payroll Paid stat to show a monetary amount instead of a count.
- **Documentation**: Created detailed flowchart documents for all core application workflows () and the loan system ().
- **Data Management**: Handled multiple user requests to clear transactional data.

**Earlier issues found/mentioned but not fixed**
- None.

**Known issue recurrence from previous fork**
- **Issue**: Payroll calculation logic remains a sensitive and complex area, being a recurring source of bugs and user-requested adjustments.
- **Recurrence count**: 4+
- **Status**: RESOLVED (but requires constant, careful regression testing).

**Code Architecture**


**Key Technical Concepts**
- **Backend**: FastAPI, Pydantic, Motor (async MongoDB).
- **Frontend**: React, Vite, Tailwind CSS, Shadcn UI.
- **State Management**: React Hooks.
- **Date/Time**:  for handling relative dates (e.g., historical EMIs).

**key DB schema**
- **cash_in**: Updated to include  and .
- **payslips**: Updated to store  to track which advances were deducted in a payslip.
- **loans**: Updated with fields like , ,  to track historical payments.

**changes in tech stack**
- None.

**All files of reference**
- : Extensive changes across payroll, bills, advances, cashbook, loans, and attendance logic.
- : Updated  and  models to include TDS fields.
- : Major overhaul for the bill approval workflow UI and logic.
- : Added TDS fields to the Add Invoice dialog and related logic.
- : **New file** created for manual historical attendance entry.
- : Added the My Leave Balance card.
- : Added the My Leave Balance card with a year selector.
- : Updated the Paid statistics card.
- : Changed the location field to a manual input.
- : Updated functions for bills and leave balances.
- : New documentation file.
- : New documentation file.

**Areas that need refactoring**:
-  is over 900 lines and should be broken down.
- , , and the new  are becoming large and could benefit from being broken into smaller components.

**key api endpoints**
- : Updated to handle TDS data.
- : Updated to handle TDS data.
- : CSV export now includes GST and TDS columns.
- : Enhanced to automatically generate historical EMI payments and Cash Out entries.
- : Now creates a Cash Out entry on approval.
- : Now stores  in the payslip document.
- : Now supports a  query parameter.

**Critical Info for New Agent**
- **Data is Volatile**: The user frequently asks to clear all test data. Assume the database is empty besides the admin account at the start of a session. All testing requires creating fresh data.
- **Payroll is Top Priority**: All financial calculations (attendance, bills, advances, leaves) culminate in the payroll. The logic to prevent double-counting in the Cashbook is especially critical. Test all changes against the payroll flow.
- **Historical Data Entry is Key**: The new features for manual attendance and historical loan entry are important to the user. Ensure their calculations and integrations with the rest of the system are robust.
- **Verify, Then Verify Again**: Many interconnected features have been added. Do not assume a fix in one area hasn't impacted another. A full, end-to-end workflow test is the highest priority before proceeding with new features.

**documents and test reports created in this job**
- 
- 
- 
-  (updated throughout the session)

**Last 10 User Messages and any pending HUMAN messages**
1.  **User**: Clears entries but wants to preserve the Team Lead ID. (Agent clears transactional data, explains users are preserved).
2.  **User**: Reports missing GST/TDS in cash-in invoice and export. (Agent implements the fix).
3.  **User**: Asks for a detailed flowchart of the cashbook loan section. (Agent provides it).
4.  **User**: Reports issue where historical EMIs for old loans aren't created automatically. (Agent implements the fix).
5.  **User**: Asks to clear all entries. (Agent clears).
6.  **User**: Requests a new feature for manual, date-wise attendance entry. (Agent implements it).
7.  **User**: Reports the payroll Paid stat shows count, not amount. (Agent fixes it).
8.  **User**: Provides corrected workflow for Advances, highlighting missing Cash Out. (Agent fixes it).
9.  **User**: Provides corrected workflow for Bills, highlighting issues with Cash Out on revalidation. (Agent fixes it).
10. **User**: Reports leave balance is not showing for team lead. (Agent adds year selector to fix it).

**Project Health Check:**
- **Broken**: No features are outright broken, but the application's core financial modules have undergone significant changes. It should be considered unstable until a full regression and end-to-end test is completed.
- **Mocked**: None.

**3rd Party Integrations**
- None.

**Testing status**
- **Testing agent used after significant changes**: YES, once for the bill revalidation feature.
- **Troubleshoot agent used after agent stuck in loop**: NO
- **Test files created**: None.
- **Known regressions**: None identified, but the risk is high due to the number of changes.

**Credentials to test flow:**
| Role | User ID | Password |
| :--- | :--- | :--- |
| Admin |  |  |

**Note**: All other users were cleared at the user's request. New employees and team leaders must be created for testing.

**What agent forgot to execute**
- The agent did not perform a final, comprehensive regression test after implementing numerous features, which is critical for a financial application.
- The agent did not explicitly re-verify the Payroll Month Mismatch bug, a known recurring critical issue, after making extensive changes to payroll logic.
- The agent did not address the test half-day attendance calculation task from the previous handoff's upcoming tasks.</analysis>
