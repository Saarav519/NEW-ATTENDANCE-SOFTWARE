<analysis>**original_problem_statement:**
The user's initial request was to add several new features to the SuperManage application, including mandatory Bank Details for employees, automatic payslip creation, new attendance rules for Team Leaders, and an Employee-to-Team-Leader mapping system with an audit history.

After these features were implemented, the user reported a series of critical issues and new requirements:
1.  **Bills – Partial Approval & Revalidation**: Admins need the ability to partially approve bills, with the remaining balance being tracked and an option to send the bill for revalidation before it's settled.
2.  **Mobile View UI/UX**: Several pages, including the Employee list and Team Leader's downline view, have overlapping options on mobile devices that need to be fixed, potentially with horizontal scrolling.
3.  **Admin Attendance Approval**: When an Admin marks attendance, the conveyance amount is auto-filled. This should be a manual input field, and the Admin should also be able to select the work location.
4.  **Team Leader Permissions**: Team Leaders should have the same permissions as Admins to mark attendance for their own team members.
5.  **Critical Payroll Bug**: A major issue where attendance from one month (e.g., December 2025) was incorrectly affecting the next month's payroll (January 2026). Generating a payslip under these conditions resulted in all salary values becoming zero. The core problem was that salary was not being calculated strictly based on approved attendance days.
6.  **Data Reset**: A request to clear all existing test data from the database so the user can test the entire workflow from scratch with fresh data.

**User's preferred language**: English

**what currently exists?**
A full-stack staff management application with a FastAPI backend, React frontend, and MongoDB. Key functionalities include:
- Role-based access for Admins, Team Leaders, and Employees.
- QR-based, direct, and manual attendance marking.
- A comprehensive payroll system where salary calculation is now strictly based on the number of approved attendance days. The earned amount is proportionally distributed into salary components (Basic, HRA, etc.).
- A preview -> generated -> settled payslip workflow. Admins can trigger recalculations for preview payslips based on the latest attendance data.
- A real-time notification system using WebSockets for events like punch-ins, leave requests, and bill submissions.
- An endpoint () to reset the application's data, leaving only the primary admin account.
- Mobile-responsive UI improvements, including horizontal scrolling for action buttons on key pages.

**Last working item**:
The agent implemented a large batch of fixes and features based on the user's latest requests. The final actions involved fixing mobile UI issues, correcting the payroll calculation logic, and adding a data-clearing endpoint. The agent verified these changes using screenshots after the user added their own new data to the cleared database.

    - Last item agent was working: Implementing and verifying a large batch of user-requested fixes, including mobile UI enhancements, new permissions for Team Leaders, and critical corrections to the payroll calculation and month-mapping logic.
    - Status: **USER VERIFICATION PENDING**
    - Agent Testing Done: Y (Visual verification via screenshots and manual API calls)
    - Which testing method agent to use? both
    - User Testing Done: N

**All Pending/In progress Issue list**:
  - **Issue 1: Critical Payroll Logic Month Mismatch (P0)**
     - **Description**: The user reported that December 2025 attendance was incorrectly appearing in the January 2026 payroll. The agent fixed the symptom by ensuring newly created payslips start with a net pay of ₹0. However, the root cause of the month mismatch needs to be re-verified to ensure it's fully resolved and doesn't reappear.
     - **Next debug checklist**:
       1.  With user-provided data, mark attendance for the last day of a month (e.g., Dec 31, 2025).
       2.  Create payslips for the next month (e.g., Jan 2026).
       3.  Verify in  that the Jan 2026 payslip shows 0 days worked.
       4.  Check the  function in  to confirm its date filtering ( and ) is correctly isolating the requested month.
     - **Why fix this issue and what will be achieved with the fix?**: This is a critical financial bug. Fixing it ensures payroll is calculated accurately for the correct period, which is fundamental to the app's purpose.
     - **Status**: TESTING PENDING
     - **Is recurring issue?**: Y
     - **Should Test frontend/backend/both after fix?**: both
     - **Blocked on other issue**: None

**In progress Task List**:
  - **Task 1: Complete Frontend for Bill Partial Approval & Revalidation (P0)**
     - **Where to resume**: The backend logic is complete in  (within the  endpoint) and the  model in  now supports , , and a  status. The next step is to modify the frontend, likely in .
     - **Implementation Steps**:
       1.  Update the Approve Bill modal to allow an admin to enter a partial amount instead of just clicking Approve.
       2.  Add a checkbox or button in the modal to flag the bill for Revalidation.
       3.  On the main bills list, display the  and .
       4.  Visually distinguish bills that are in  status.
     - **What will be achieved with this?**: This will complete the user's requirement for a more flexible and realistic bill approval workflow.
     - **Status**: IN PROGRESS
     - **Should Test frontend/backend/both after fix?**: both
     - **Blocked on something**: None

**Upcoming and Future Tasks**

**Upcoming Tasks:**
-   **P1**: Thoroughly test the half-day attendance calculation. The UI for marking Half Day exists, but its impact on the  and final payslip needs to be verified.
-   **P1**: Test the complete Revalidation workflow for bills once the frontend is built.

**Future Tasks:**
-   Refactor the  component (currently over 900 lines).
-   Implement multi-language support.
-   Implement a dark mode theme.

**Completed work in this session**
- **Core Feature Implementation**:
  - Implemented mandatory Bank Details and Employee-Team Leader mapping.
  - Added an Audit Expenses report and merged the Bills and Advances reports.
- **Critical Payroll Fixes**:
  - **Recalculation Logic**: Fixed a major bug where payslips ignored attendance. Implemented Refresh buttons () to update payslips with the latest attendance data.
  - **Proportional Salary Distribution**: Corrected the calculation logic to distribute the total earned amount proportionally across salary components (Basic, HRA, etc.), as per user's precise instructions.
  - **Month Mismatch Fix**: Ensured that newly created monthly payslips start with ₹0 net pay instead of the full salary.
- **Data Management**:
  - Created a  endpoint to reset all transactional data for fresh testing.
- **User-Requested Fixes & Features**:
  - **Admin Attendance**: Updated the Mark Attendance UI and API to allow manual input of Conveyance and Location.
  - **Mobile UI**: Fixed overlapping elements on the Employees, Team, and Attendance pages by implementing responsive layouts and horizontal scrolling.
  - **Team Leader Permissions**: Enabled Team Leaders to mark attendance for their downline members directly from the Team page.
  - **Bill Workflow**: Added backend support for partial bill approvals and a revalidation status.

**Earlier issues found/mentioned but not fixed**
- None.

**Known issue recurrence from previous fork**
- **Issue**: Payroll calculation logic has been a recurring point of failure and clarification.
- **Recurrence count**: 3+ times in this session.
- **Status**: RESOLVED (but requires careful monitoring). The latest implementation correctly distributes earned salary proportionally, which has been verified.

**Code Architecture**


**Key Technical Concepts**
- **Backend**: FastAPI, Pydantic, Motor (async MongoDB).
- **Frontend**: React, Vite, Tailwind CSS, Shadcn UI.
- **State Management**: React Hooks and Context API.
- **Real-time**: WebSockets for push notifications.

**key DB schema**
- **bills**: Updated with , . The  enum now includes a  state.
- **users**: 
- **team_leader_history**: 

**changes in tech stack**
- None.

**All files of reference**
- : Major changes to payroll calculation, bill approval (), attendance marking (), and the new data clearing endpoint ().
- : Updated  model and  enum.
- : Completely rewritten to be mobile-responsive and include a modal for marking attendance with conveyance/location fields.
- : Updated for mobile-responsiveness and to allow Team Leaders to mark team attendance.
- : Updated for mobile view with horizontally scrolling action buttons.
- : Updated with Refresh functionality, and new table columns to show attendance-based salary calculations correctly.
- : Added new API functions for payslip recalculation.
- : Updated to reflect completed features.

**Areas that need refactoring**:
-  is over 900 lines and should be broken down into smaller components.

**key api endpoints**
- : Updated to accept  and .
- : Updated to accept  and handle revalidation status.
- : Refreshes a single preview payslip based on current attendance.
- : Refreshes all preview payslips for a given month.
- : Clears all transactional data, keeping only the main admin account.

**Critical Info for New Agent**
- **Payroll Calculation is Sacred**: The user is extremely particular about this. The current, correct logic is:  is calculated from attendance days. This earned amount is then distributed proportionally into Basic, HRA, etc. . Do not change this without explicit instructions.
- **Work on User's Data ONLY**: The database has been reset. The user will provide all data for testing. DO NOT add any dummy employees or entries.
- **Bill Revalidation Frontend is Missing**: The immediate task is to build the UI for the partial bill approval and revalidation feature. The backend is already prepared.
- **Mobile View is a Priority**: The user has specifically requested fixes for mobile usability. Ensure all new UI is tested for mobile responsiveness.

**documents and test reports created in this job**
- 
-  (updated)

**Last 10 User Messages and any pending HUMAN messages**
1.  **User**: Reports critical bug: payroll calculation is wrong and not based on attendance.
2.  **Agent**: Investigates and confirms the bug where preview payslips are created with full salary.
3.  **Agent**: Implements a Recalculate feature to refresh payslips based on actual attendance. Verifies the fix.
4.  **User**: Clarifies the exact proportional calculation logic required: earned salary should be calculated first, then distributed into components (Basic, HRA, etc.).
5.  **Agent**: Implements the user's precise proportional calculation logic and verifies it works correctly.
6.  **User**: Requests a way to delete all test data to start fresh from December 2025.
7.  **Agent**: Creates and executes a  endpoint, verifying the database is clean.
8.  **User**: Prohibits agent from adding any test data and provides a new list of issues: Bill Revalidation, Mobile View Overlapping, TL Attendance Permissions, Admin Attendance manual inputs, and the critical Payroll Month Mismatch bug.
9.  **Agent**: Acknowledges the new tasks and begins implementing fixes without adding data.
10. **Agent**: Implements backend/frontend fixes for all reported issues and verifies them via screenshots using the user's new data, confirming correct behavior (e.g., new payslips show ₹0 salary).

**Project Health Check:**
- **Broken**: The bill approval workflow is functionally incomplete because the frontend UI for partial approval and revalidation has not been implemented.
- **Mocked**: None.

**3rd Party Integrations**
- None.

**Testing status**
- **Testing agent used after significant changes**: YES (for P0 features). The latest batch of fixes has not been tested by the agent yet.
- **Troubleshoot agent used after agent stuck in loop**: NO
- **Test files created**: None.
- **Known regressions**: None.

**Credentials to test flow:**
| Role | User ID | Password |
| :--- | :--- | :--- |
| Admin |  |  |

The user will create all other employee/team leader accounts for testing.

**What agent forgot to execute**
The agent implemented the backend logic for bill partial approval and revalidation but did not build the corresponding frontend interface. This leaves the feature incomplete and unusable for the user.</analysis>
